<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    body { background-image: url('../wallpaper.jpg'); background-size: cover; background-attachment: fixed; }
    .container { max-width: 900px; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="nav-links">
      <a href="../index.html">ğŸ  Dashboard</a>
      <a href="pump-control.html">âš™ Pump Control</a>
      <a href="water-usage.html">ğŸ’§ Water Usage</a>
      <a href="status-report.html">ğŸ“Š Status Report</a>
      <a href="notifications.html">ğŸ”” Notifications</a>
      <a href="reports.html">ğŸ§¾ Reports</a>
      <a href="settings.html">ğŸ”§ Settings</a>
    </div>
    <div class="nav-status">
      <span class="badge badge-primary" data-app-nav="mode">Mode: --</span>
      <span class="badge badge-success" data-app-nav="pump">Pump: --</span>
      <span class="badge badge-secondary" data-app-nav="water">Water: 0.0 L</span>
    </div>
    <div class="nav-controls">
      <label class="toggle">
        <input type="checkbox" data-app-toggle="theme">
        <span>Dark</span>
      </label>
      <label class="toggle">
        <input type="checkbox" data-app-toggle="mode">
        <span>Hardware</span>
      </label>
    </div>
  </div>

  <div class="container">
    <h1>Settings</h1>
    <div style="display:grid; gap:16px;">
      <label><input type="checkbox" id="darkToggle"> Enable Dark Mode</label>
      <label><input type="checkbox" id="hardwareToggle"> Enable Hardware Mode</label>
      <label>Moisture Threshold (Pump ON below): <input id="moistThreshold" type="number" min="0" max="1000" value="500"></label>
      <label><input type="checkbox" id="autoMode"> Auto Pump Mode</label>
      <button id="saveBtn">Save Settings</button>
    </div>
  </div>
  <script src="../assets/js/common.js"></script>
  <script>
    document.body.style.backgroundImage = "url('../wallpaper.jpg')";

    // Sync toggles with backend status
    async function sync(){
      try { 
        const r1 = await fetch('/api/status'); const j = await r1.json();
        document.getElementById('hardwareToggle').checked = (j.mode === 'hardware');
        const r2 = await fetch('/api/settings'); const s = await r2.json();
        document.getElementById('moistThreshold').value = Number(s.moisture_threshold || 500);
        document.getElementById('autoMode').checked = !!s.auto_mode;
      } catch{}
    }
    sync();

    const darkToggle = document.getElementById('darkToggle');
    const hardwareToggle = document.getElementById('hardwareToggle');

    if (window.AppShell) {
      const currentTheme = window.AppShell.getState().theme;
      darkToggle.checked = currentTheme === 'dark';
      window.AppShell.onStatus((status) => {
        if (status?.mode) {
          hardwareToggle.checked = status.mode === 'hardware';
        }
      });
      window.AppShell.onTheme((theme) => {
        darkToggle.checked = theme === 'dark';
      });
    } else {
      const dark = localStorage.getItem('theme') === 'dark';
      darkToggle.checked = dark;
    }

    darkToggle.addEventListener('change', (e)=>{
      if (window.AppShell) {
        window.AppShell.setTheme(e.target.checked ? 'dark' : 'light');
      } else {
        const mode = e.target.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', e.target.checked ? 'dark' : '');
        localStorage.setItem('theme', mode);
      }
    });

    hardwareToggle.addEventListener('change', async (e)=>{
      if (window.AppShell) {
        window.AppShell.setMode(e.target.checked ? 'hardware' : 'simulation');
        return;
      }
      try { await fetch('/api/mode', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ mode: e.target.checked ? 'hardware' : 'simulation' }) }); } catch{}
    });
    document.getElementById('saveBtn').addEventListener('click', async ()=>{
      try {
        const payload = {
          moisture_threshold: Number(document.getElementById('moistThreshold').value || 500),
          auto_mode: document.getElementById('autoMode').checked
        };
        await fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        alert('Settings saved');
      } catch(e) { alert('Failed to save'); }
    });
  </script>
</body>
</html>
